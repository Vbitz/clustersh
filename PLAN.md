# Cluster Shell

`clustersh` is a simple tool designed to let AI agents run commands on other computer systems.

It's made of 3 executables:

- `clustersh` the frontend command.
- `clusterd` the central coordinator proxy.
- `clusteragent` the backend agent that executes commands.

## Examples

```sh
$ clustersh machines
name          | platform
==============|==============
joshua-ws1    | linux/amd64
joshua-mba    | darwin/arm64

$ clustersh run joshua-ws1 "ls -la"
<files in ~/>

$ clustersh run --file hello joshua-ws1 "cat hello"
<changed to a temporary directory>
<contents of hello>

$ clustersh run joshua-mba "long command"
ERROR: output length exceeded limit, use clustersh cat joshua-mba <uuid> to read output.

$ clustersh cat joshua-mba <uuid> | tail -n10
<last 10 lines>

$ clustersh run joshua-ws1 "sleep <6 minutes>"
ERROR: command timed out after 5 minutes

$ clustersh run joshua-ws1 --timeout 10m "sleep <6 minutes>"
<success>

$ clustersh history joshua-ws1
uuid    | time    | command      | status
========|=========|==============|=======================
<blah>  | <blah>  | <blah>       | completed after 1m20s

$ clustersh cancel joshua-ws1 <uuid>
Command cancelled.
```

## Security

`clusterd` maintains a CA certificate used to sign machines to give them access. It can hand out `frontend` certificates and `agent` certificates.

Frontend certificates are generated using `clustersh login` which generates a keypair and sends a signed message to the host. e.g. `clustersh login http://joshua-ws1:5672`. That responds with a command `clusterd approve <8 char hex string>` which is run to add the fingerprint to the trusted connection list. This is normally done with `curl http://joshua-ws1:5672/install_client.sh | bash`

Agents can freely register with the coordinator using a shell script generated by `clusterd` and run with `curl http://joshua-ws1:5672/install.sh | bash` (or `.ps1` for Windows). Once registered they show up as machines and can have commands remotely run by clients.

The underlying transport between systems is Tailscale connectivity between hosts on my local network.

## Architecture

Persistent state is stored in `~/.config/clustersh/`. JSON files are used for job results, certificates, and other information.

Agents establish persistent connections with the coordinator over websockets. Agents keep command logs locally so they can be retrieved at a later date. If an agent loses connection it will attempt reconnection every 10 minutes.

The frontend uses a REST API to execute commands.

## Configuration

All components store configuration in `~/.config/clustersh/`. The coordinator port is configurable (default shown in examples).

## Behavior

**Output limits**: Command output over 128 KB is truncated and must be retrieved with `clustersh cat`. This limit is sized for AI agent context windows.

**File transfer**: The `--file` flag supports both files and directories (recursive transfer). Files are placed in a temporary directory on the agent before command execution.

**Offline agents**: Commands sent to offline agents fail immediately.

**Concurrency**: Multiple commands can run in parallel on the same agent. There is no enforced limit.

**Agent naming**: Agents default to using the system hostname, but the name can be overridden in configuration.

**Disconnection handling**: Agents store all commands and results locally. If an agent restarts and detects commands that were still running, it marks them as failed.

**Data retention**: Job results and logs are retained indefinitely.

**Shell**: Commands are executed using bash on Unix systems and PowerShell on Windows.

**Working directory**: Commands run in the agent user's home directory by default. When `--file` is used, commands run in a temporary directory containing the transferred files.

**Output delivery**: Output is returned when the command completes, not streamed in real-time.

**Exit codes**: Exit codes are always included in command results. Non-zero exit codes are also flagged as failures.

**Cancellation**: Running commands can be cancelled with `clustersh cancel <uuid>`.

**Isolation**: Commands run as the agent user with full access. No sandboxing is applied.

**Audit logging**: The coordinator maintains a log of all commands executed, including which client initiated them. This provides a centralized audit trail.